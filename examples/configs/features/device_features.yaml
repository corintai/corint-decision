# Device Feature Definitions
#
# Features computed based on device_id dimension.

features:
  # ============================================================================
  # Device Activity Features
  # ============================================================================

  - name: device_event_count_24h
    description: "Total events from this device in last 24 hours"
    operator: count
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: "{event.device_id}"
    window:
      value: 24
      unit: hours
    cache:
      enabled: true
      ttl: 300

  - name: device_transaction_count_24h
    description: "Transactions from this device in last 24 hours"
    operator: count
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: "{event.device_id}"
    window:
      value: 24
      unit: hours
    filters:
      - field: event_type
        operator: eq
        value: "transaction"
    cache:
      enabled: true
      ttl: 300

  # ============================================================================
  # Cross-Dimensional Features
  # ============================================================================

  - name: users_per_device_30d
    description: "Number of distinct users on this device in last 30 days"
    operator: count_distinct
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: "{event.device_id}"
    distinct_field: user_id
    window:
      value: 30
      unit: days
    cache:
      enabled: true
      ttl: 3600

  - name: ips_per_device_7d
    description: "Number of distinct IPs for this device in last 7 days"
    operator: count_distinct
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: "{event.device_id}"
    distinct_field: ip_address
    window:
      value: 7
      unit: days
    cache:
      enabled: true
      ttl: 600

  # ============================================================================
  # Temporal Features
  # ============================================================================

  - name: device_first_seen
    description: "First time this device was seen"
    operator: first_seen
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: "{event.device_id}"

  - name: device_age_days
    description: "Days since device first seen"
    operator: time_since
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: "{event.device_id}"
    unit: days

  # ============================================================================
  # Device Profile Lookups
  # ============================================================================

  - name: device_is_suspicious
    description: "Is device marked as suspicious?"
    operator: profile_lookup
    datasource: supabase_events
    table: device_registry
    dimension: device_id
    dimension_value: "{event.device_id}"
    field: is_suspicious

  - name: device_is_emulator
    description: "Is device an emulator?"
    operator: profile_lookup
    datasource: supabase_events
    table: device_registry
    dimension: device_id
    dimension_value: "{event.device_id}"
    field: is_emulator
