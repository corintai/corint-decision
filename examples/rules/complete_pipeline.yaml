version: "0.1"

# Complete Payment Risk Control Example
# Multi-Ruleset Risk Assessment
#
# NOTE: This demonstrates multiple rulesets working together, but does NOT
# implement true pipeline routing. All rulesets execute sequentially, with
# the last one's action winning.
#
# Current Architecture (Sequential Execution):
# 1. Risk Detection Rules - Calculate risk scores (5 rules execute)
# 2. Transaction Router - First ruleset executes
# 3. High-Value Pipeline - Second ruleset executes
# 4. Standard Pipeline - Third ruleset executes (final action wins)
#
# True Pipeline DSL (with conditional routing) is documented but not yet implemented.
# See docs/dsl/pipeline.md for the full pipeline specification.

# ========================================
# STAGE 1: RISK DETECTION RULES
# ========================================

# Rule 1: High-Risk Country Detection
rule:
  id: high_risk_country
  name: High-Risk Country
  description: Geographic risk assessment

  when:
    event.type: payment
    conditions:
      - country_code == "NG" || country_code == "GH" || country_code == "ID"

  score: 30

---

# Rule 2: Card Testing Pattern
rule:
  id: card_testing
  name: Card Testing Detection
  description: Multiple small transactions pattern

  when:
    event.type: payment
    conditions:
      - payment_attempts_1h >= 5
      - payment_amount < 10
      - unique_cards_1h >= 3

  score: 80

---

# Rule 3: Velocity Check
rule:
  id: velocity_check
  name: Velocity Violation
  description: High transaction frequency

  when:
    event.type: payment
    conditions:
      - transaction_count_24h > 20

  score: 50

---

# Rule 4: New Account Risk
rule:
  id: new_account_risk
  name: New Account High-Value
  description: New account with large purchase

  when:
    event.type: payment
    conditions:
      - account_age_days < 7
      - payment_amount > 500

  score: 60

---

# Rule 5: Suspicious Email
rule:
  id: suspicious_email
  name: Suspicious Email Pattern
  description: Disposable or random email

  when:
    event.type: payment
    conditions:
      - is_disposable_email == true

  score: 35

---

# ========================================
# STAGE 2: FIRST RULESET
# ========================================
# This is the first ruleset that executes (but not the only one)

ruleset:
  id: transaction_router
  name: First Decision Ruleset

  description: |
    First ruleset in the execution sequence.
    Handles critical fraud patterns with immediate blocking.

  rules:
    - high_risk_country
    - card_testing
    - velocity_check
    - new_account_risk
    - suspicious_email

  decision_logic:
    # Critical patterns - immediate block
    - condition: triggered_rules contains "card_testing"
      action: deny
      reason: "BLOCKED: Card testing pattern detected"
      terminate: true

    # High risk transactions
    - condition: total_score >= 80
      action: challenge
      reason: "High risk - require additional verification"
      terminate: true

    # Medium risk transactions
    - condition: total_score >= 40
      action: review
      reason: "Medium risk - manual review required"
      terminate: true

    # Low risk - approve
    - default: true
      action: approve
      reason: "Low risk - approved"

---

# ========================================
# STAGE 3: SECOND RULESET
# ========================================
# This is the second ruleset that executes

ruleset:
  id: high_value_pipeline
  name: Second Decision Ruleset

  description: |
    Second ruleset in the execution sequence.
    Applies stricter thresholds for high-risk scenarios.

  rules:
    - high_risk_country
    - card_testing
    - velocity_check
    - new_account_risk
    - suspicious_email

  decision_logic:
    # Critical patterns
    - condition: |
        triggered_rules contains "card_testing" ||
        triggered_rules contains "new_account_risk"
      action: deny
      reason: "Critical fraud pattern detected"
      terminate: true

    # High score threshold
    - condition: total_score >= 60
      action: deny
      reason: "Risk score too high"
      terminate: true

    # Multiple risk indicators
    - condition: triggered_count >= 2
      action: review
      reason: "Multiple risk indicators detected"
      terminate: true

    # Single risk indicator
    - condition: triggered_count >= 1
      action: challenge
      reason: "Require additional authentication"
      terminate: true

    # Clean transaction
    - default: true
      action: approve
      reason: "Clean transaction"

---

# ========================================
# STAGE 4: THIRD RULESET (FINAL)
# ========================================
# This is the last ruleset - its action will be the final decision

ruleset:
  id: standard_pipeline
  name: Final Decision Ruleset

  description: |
    Third and final ruleset in the execution sequence.
    Since this executes last, its action will be the final decision.
    Balanced risk thresholds for normal transactions.

  rules:
    - high_risk_country
    - card_testing
    - velocity_check
    - new_account_risk
    - suspicious_email

  decision_logic:
    # Critical patterns only
    - condition: triggered_rules contains "card_testing"
      action: deny
      reason: "Card testing detected"
      terminate: true

    # High score threshold
    - condition: total_score >= 100
      action: deny
      reason: "High fraud risk"
      terminate: true

    # Medium-high score
    - condition: total_score >= 60
      action: challenge
      reason: "Require verification"
      terminate: true

    # Medium score
    - condition: total_score >= 40
      action: review
      reason: "Manual review needed"
      terminate: true

    # Multiple risk indicators
    - condition: triggered_count >= 3
      action: review
      reason: "Multiple risk signals"
      terminate: true

    # Low risk (default)
    - default: true
      action: approve
      reason: "Normal transaction"

---

# ========================================
# METADATA (Documentation Only)
# ========================================
# This section is purely for documentation and is not processed by the engine.
# It will be skipped during parsing.

metadata:
  version: "1.0.0"
  last_updated: "2024-12-03"

  note: |
    This file demonstrates multiple rulesets working together.

    Current Implementation:
    - All 5 rules execute first (accumulate scores)
    - Then all 3 rulesets execute sequentially
    - The last ruleset's action becomes the final decision

    Limitation:
    - No conditional routing (e.g., "if high-value, execute pipeline A")
    - All rulesets always execute in order
    - True pipeline DSL with routing is documented but not implemented

    See docs/dsl/pipeline.md for the full pipeline specification.

  execution_order:
    1. "high_risk_country rule"
    2. "card_testing rule"
    3. "velocity_check rule"
    4. "new_account_risk rule"
    5. "suspicious_email rule"
    6. "transaction_router ruleset"
    7. "high_value_pipeline ruleset"
    8. "standard_pipeline ruleset (final action wins)"
