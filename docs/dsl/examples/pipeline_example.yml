# =============================================================================
# CORINT Decision Engine - Complete DSL Example
# =============================================================================
#
# This comprehensive example demonstrates core pipeline DSL concepts in one file:
#   - Pipeline structure and orchestration
#   - API integration (GET, POST, PUT, PATCH)
#   - Condition syntax (all/any/not with arbitrary nesting)
#   - Step types (router, api, service, ruleset, pipeline)
#   - Conditional routing and decision logic
#   - Context variables and data flow
#   - Final decision rules with actions
#
# Design Goals:
#   1. DAG IR compilation friendly - explicit entry, unique IDs, clear edges
#   2. Visualization friendly - distinguishable node types, clear routing
#   3. LLM generation friendly - structured schema, clear constraints
#
# =============================================================================

# =============================================================================
# PART 1: Schema Definition
# =============================================================================
#
# Pipeline:
#   id:          string (required, unique, snake_case)
#   name:        string (required, human readable)
#   description: string (optional)
#   version:     string (optional, semver format)
#   entry:       string (required, must match a step.id)
#   when:        Condition (optional, pipeline-level filter)
#   steps:       Step[] (required, non-empty)
#
# Step:
#   id:      string (required, unique within pipeline, snake_case)
#   name:    string (required, human readable)
#   type:    StepType (required)
#   ...type-specific fields...
#   routes:  Route[] (optional, conditional routing)
#   default: string (optional, default next step if no route matches)
#   next:    string | "end" (optional, unconditional next step)
#
# Route (consistent with registry format):
#   next:    string (required, target step id or "end")
#   when:    Condition (required, jump condition)
#
# StepType:
#   - router   : pure routing judgment (no computation)
#   - rule     : execute single rule
#   - ruleset  : execute ruleset
#   - pipeline : call sub-pipeline
#   - service  : internal service call (DB, Redis, internal API)
#   - api      : external API call (third-party service)
#
# Condition (unified format, supports arbitrary nesting):
#   - string: single boolean expression (e.g., "event.amount > 100")
#   - { all: [...] }: all conditions must be true (AND)
#   - { any: [...] }: at least one condition is true (OR)
#   - { not: [...] }: condition negation (NOT)
#
# Context Variables:
#   - event.*     : Event data (e.g., event.amount, event.user.id)
#   - features.*  : Computed features (e.g., features.transaction_count_7d)
#   - api.*       : External API results (e.g., api.fraud_detector.check_ip)
#   - service.*   : Internal service results (e.g., service.user_profile.vip_level)
#   - vars.*      : Simple variables (e.g., vars.total_score)
#   - sys.*       : System metadata (e.g., sys.request_id, sys.timestamp)
#   - results.*   : Ruleset results (e.g., results.fraud_detection.signal)
#
# =============================================================================

version: "0.1"

# =============================================================================
# PART 2: External API Configuration
# =============================================================================
#
# API definitions are referenced by pipeline steps of type "api"
# See repository/configs/apis/ for actual API configuration files
#
# Example API Configuration (fraud_detector):
# ---
# name: fraud_detector
# base_url: "https://api.frauddetector.example.com"
# auth:
#   type: header
#   name: "X-API-Key"
#   value: "@{api.fraud_detector.api_key}"
# timeout_ms: 5000
# endpoints:
#   check_ip:
#     method: GET
#     path: "/v1/ip/{ip_address}"
#     timeout_ms: 3000
#     params:
#       ip_address: event.ip_address
#     response:
#       mapping:
#         risk_score: riskScore
#         is_vpn: vpn
#         is_proxy: proxy
#   analyze_transaction:
#     method: POST
#     path: "/v1/transactions/analyze"
#     timeout_ms: 10000
#     params:
#       transaction_id: event.transaction_id
#       amount: event.amount
#       currency: event.currency
#     request_body: |
#       {
#         "transaction_id": "${transaction_id}",
#         "amount": ${amount},
#         "currency": "${currency}"
#       }
#     response:
#       mapping:
#         risk_score: analysis.riskScore
#         recommendation: analysis.recommendation
#         confidence: analysis.confidence
#         reason_codes: analysis.reasonCodes
# =============================================================================
# Additional API configs (maxmind_api, ipinfo_api, ip2location_api, credit_bureau_api,
# identity_verification_api, device_fingerprint_api) follow the same pattern.

import:
  rulesets:
    - library/rulesets/payment_high_value.yaml
    - library/rulesets/payment_standard.yaml
    - library/rulesets/vip_fast_rules.yaml
    - library/rulesets/cn_region_rules.yaml
  pipelines:
    - library/pipelines/high_value_verification.yaml

---

pipeline:
  id: comprehensive_fraud_pipeline
  name: Comprehensive Fraud Detection Pipeline
  description: |
    Complete pipeline example demonstrating core DSL features:
    - API integration (GET, POST, PUT, PATCH)
    - Complex conditional routing with nested all/any/not
    - Multiple step types (router, api, service, ruleset, pipeline)
    - Context variable usage across different namespaces
    - Error handling and fallback logic
  version: "2.0.0"

  # ==========================================================================
  # Pipeline Entry Point and Activation Condition
  # ==========================================================================
  entry: check_ip_reputation

  # Pipeline-level filter (coarse-grained filtering)
  when:
    all:
      - event.type == "payment"
      - event.channel in ["stripe", "paypal", "square"]
      - event.amount > 0
      - event.amount < 50000

  # ==========================================================================
  # Pipeline Steps
  # ==========================================================================
  steps:
    # ========================================================================
    # Step 1: IP Reputation Check (GET API)
    # Demonstrates: GET request, simple routing
    # ========================================================================
    - step:
        id: check_ip_reputation
        name: Check IP Reputation
        type: api
        api: fraud_detector
        endpoint: check_ip
        # Parameters defined in API config: ip_address: event.ip_address
        # Result stored in: api.fraud_detector.check_ip
        routes:
          # High-risk IP detected
          - next: manual_review
            when:
              any:
                - api.fraud_detector.check_ip.risk_score >= 80
                - api.fraud_detector.check_ip.is_vpn == true
                - api.fraud_detector.check_ip.is_proxy == true
          # Clean IP, proceed to next check
          - next: amount_router
            when:
              all:
                - api.fraud_detector.check_ip.risk_score < 50
        default: enhanced_ip_check

    # ========================================================================
    # Step 2a: Enhanced IP Check (Primary Provider)
    # Demonstrates: Fallback API pattern without parallel fan-out
    # ========================================================================
    - step:
        id: enhanced_ip_check
        name: Enhanced IP Check (Primary Provider)
        type: api
        api: maxmind_api
        endpoint: ip_lookup
        routes:
          # Fallback if primary provider errors
          - next: ipinfo_ip_check
            when: api.maxmind_api.ip_lookup.error == true
        default: amount_router

    # ========================================================================
    # Step 2b: Enhanced IP Check (Fallback 1)
    # Demonstrates: Sequential fallback to secondary provider
    # ========================================================================
    - step:
        id: ipinfo_ip_check
        name: Enhanced IP Check (Fallback 1)
        type: api
        api: ipinfo_api
        endpoint: ip_lookup
        routes:
          # Fallback if first fallback errors
          - next: ip2location_ip_check
            when: api.ipinfo_api.ip_lookup.error == true
        default: amount_router

    # ========================================================================
    # Step 2c: Enhanced IP Check (Fallback 2)
    # Demonstrates: Final fallback before resuming flow
    # ========================================================================
    - step:
        id: ip2location_ip_check
        name: Enhanced IP Check (Fallback 2)
        type: api
        api: ip2location_api
        endpoint: ip_lookup
        next: amount_router

    # ========================================================================
    # Step 3: Amount-based Routing (Router Step)
    # Demonstrates: Complex nested conditions with all/any/not
    # ========================================================================
    - step:
        id: amount_router
        name: Amount-based Transaction Router
        type: router
        routes:
          # ----------------------------------------------------------------
          # Route 1: VIP Fast Track
          # Condition: High value + VIP status + Clean history
          # ----------------------------------------------------------------
          - next: vip_fast_track
            when:
              all:
                - event.amount > 10000
                - event.user.vip_status == true
                - not:
                    - "fraud" in event.user.tags
                    - "suspicious" in event.user.tags

          # ----------------------------------------------------------------
          # Route 2: High Value with Enhanced Verification
          # Condition: Very high amount OR (high amount + risk factors)
          # ----------------------------------------------------------------
          - next: high_value_verification
            when:
              any:
                # Very high amount always requires verification
                - event.amount >= 5000
                # High amount + any risk factor
                - all:
                    - event.amount >= 1000
                    - any:
                        - features.failed_login_count_24h >= 3
                        - features.device_count_7d >= 5
                        - event.geo.country in ["NG", "PK", "UA", "RU"]

          # ----------------------------------------------------------------
          # Route 3: China Region Specific Flow
          # ----------------------------------------------------------------
          - next: cn_region_flow
            when:
              all:
                - event.geo.country == "CN"
                - event.amount > 100

        # Default: Standard flow for normal transactions
        default: transaction_analysis

    # ========================================================================
    # Step 4: VIP Fast Track (Ruleset)
    # Demonstrates: Simple ruleset execution
    # ========================================================================
    - step:
        id: vip_fast_track
        name: VIP Fast Track Processing
        type: ruleset
        ruleset: vip_fast_rules
        next: final_decision

    # ========================================================================
    # Step 5: High Value Verification (Sub-Pipeline)
    # Demonstrates: Sub-pipeline call
    # ========================================================================
    - step:
        id: high_value_verification
        name: High Value Transaction Verification
        type: pipeline
        pipeline: high_value_verification
        # Sub-pipeline context automatically merged back
        next: final_scoring

    # ========================================================================
    # Step 6: China Region Flow (Ruleset)
    # Demonstrates: Region-specific ruleset
    # ========================================================================
    - step:
        id: cn_region_flow
        name: China Region Processing
        type: ruleset
        ruleset: cn_region_rules
        next: transaction_analysis

    # ========================================================================
    # Step 7: Transaction Analysis (POST API)
    # Demonstrates: POST request with complex body, response mapping
    # ========================================================================
    - step:
        id: transaction_analysis
        name: Analyze Transaction
        type: api
        api: fraud_detector
        endpoint: analyze_transaction
        # Parameters defined in API config
        # Request body: complex JSON with nested objects
        # Result stored in: api.fraud_detector.analyze_transaction
        routes:
          # Critical risk detected by API
          - next: auto_reject
            when:
              all:
                - api.fraud_detector.analyze_transaction.risk_score >= 90
                - api.fraud_detector.analyze_transaction.recommendation == "DECLINE"
          # High risk but not critical
          - next: credit_bureau_check
            when:
              any:
                - api.fraud_detector.analyze_transaction.risk_score >= 70
                - api.fraud_detector.analyze_transaction.confidence < 0.6
        default: standard_scoring

    # ========================================================================
    # Step 8a: Credit Bureau Check (API)
    # Demonstrates: Multi-source analysis with explicit steps
    # ========================================================================
    - step:
        id: credit_bureau_check
        name: Credit Bureau Check
        type: api
        api: credit_bureau_api
        endpoint: credit_score
        next: identity_verification

    # ========================================================================
    # Step 8b: Identity Verification (API)
    # ========================================================================
    - step:
        id: identity_verification
        name: Identity Verification
        type: api
        api: identity_verification_api
        endpoint: verify_identity
        next: device_fingerprint

    # ========================================================================
    # Step 8c: Device Fingerprint Check (API)
    # ========================================================================
    - step:
        id: device_fingerprint
        name: Device Fingerprint Check
        type: api
        api: device_fingerprint_api
        endpoint: fingerprint
        # Results stored in: api.{api_name}.{endpoint}
        next: aggregate_scores

    # ========================================================================
    # Step 9: Aggregate Scores (Service Call)
    # Demonstrates: Internal service call, weighted aggregation
    # ========================================================================
    - step:
        id: aggregate_scores
        name: Aggregate Risk Scores
        type: service
        service: risk_aggregator
        endpoint: aggregate_scores
        params:
          api_scores:
            - api.fraud_detector.analyze_transaction.risk_score
            - api.credit_bureau_api.credit_score.score
            - api.identity_verification_api.verify_identity.trust_score
            - api.device_fingerprint_api.fingerprint.risk_score
          weights:
            fraud_detector: 0.4
            credit_bureau: 0.2
            identity_verification: 0.2
            device_fingerprint: 0.2
        # Result stored in: service.risk_aggregator.aggregate_scores
        next: standard_scoring

    # ========================================================================
    # Step 10: Standard Scoring (Ruleset)
    # Demonstrates: Standard ruleset execution
    # ========================================================================
    - step:
        id: standard_scoring
        name: Standard Risk Scoring
        type: ruleset
        ruleset: payment_standard
        next: final_decision

    # ========================================================================
    # Step 11: Final Scoring (Ruleset)
    # Demonstrates: Final scoring from high-value flow
    # ========================================================================
    - step:
        id: final_scoring
        name: Final Risk Assessment
        type: ruleset
        ruleset: payment_high_value
        next: final_decision

    # ========================================================================
    # Step 12: Final Decision Router
    # Demonstrates: Complex decision logic with nested conditions
    # ========================================================================
    - step:
        id: final_decision
        name: Final Decision Point
        type: router
        routes:
          # ----------------------------------------------------------------
          # Auto Approve: VIP fast-track or clean approvals
          # ----------------------------------------------------------------
          - next: auto_approve
            when:
              any:
                - results.vip_fast_rules.signal == "approve"
                - all:
                    - any:
                        - results.payment_standard.signal == "approve"
                        - results.payment_high_value.signal == "approve"
                    - api.fraud_detector.analyze_transaction.risk_score < 50
                    - not:
                        - any:
                            - features.fraud_history_count > 0
                            - api.fraud_detector.check_ip.is_vpn == true
                            - api.fraud_detector.check_ip.is_proxy == true

          # ----------------------------------------------------------------
          # Auto Reject: Multiple high-risk indicators
          # ----------------------------------------------------------------
          - next: auto_reject
            when:
              any:
                - results.vip_fast_rules.signal == "decline"
                - results.payment_standard.signal == "decline"
                - results.payment_high_value.signal == "decline"
                - results.cn_region_rules.signal == "decline"
                - api.fraud_detector.analyze_transaction.risk_score >= 90
                - api.fraud_detector.check_ip.risk_score >= 80

          # ----------------------------------------------------------------
          # High Priority Review: Elevated risk or mixed signals
          # ----------------------------------------------------------------
          - next: priority_review
            when:
              any:
                - results.vip_fast_rules.signal == "review"
                - results.payment_standard.signal == "review"
                - results.payment_high_value.signal == "review"
                - results.cn_region_rules.signal == "review"
                - api.fraud_detector.analyze_transaction.risk_score >= 50

        # Default: Standard manual review
        default: manual_review

    # ========================================================================
    # Step 13: Auto Approve (Service)
    # Demonstrates: Approval service call
    # ========================================================================
    - step:
        id: auto_approve
        name: Auto Approve Transaction
        type: service
        service: approval_service
        endpoint: approve_transaction
        params:
          decision: approve
          reason: "Low risk score"
          confidence: api.fraud_detector.analyze_transaction.confidence
        next: update_success_metrics

    # ========================================================================
    # Step 14: Auto Reject (Service)
    # Demonstrates: Rejection service call with update
    # ========================================================================
    - step:
        id: auto_reject
        name: Auto Reject Transaction
        type: service
        service: rejection_service
        endpoint: reject_transaction
        params:
          decision: reject
          reason: "High risk score"
          risk_factors: api.fraud_detector.analyze_transaction.reason_codes
        next: update_risk_score

    # ========================================================================
    # Step 15: Priority Review (Service)
    # Demonstrates: Queue management with priority
    # ========================================================================
    - step:
        id: priority_review
        name: Send to Priority Review Queue
        type: service
        service: case_management
        endpoint: enqueue_case
        params:
          queue: "high_priority_review"
          priority: "high"
          assignee: "risk_team_lead"
          context:
            risk_score: api.fraud_detector.analyze_transaction.risk_score
            amount: event.amount
            risk_factors: api.fraud_detector.analyze_transaction.reason_codes
        next: end

    # ========================================================================
    # Step 16: Manual Review (Service)
    # Demonstrates: Standard queue management
    # ========================================================================
    - step:
        id: manual_review
        name: Send to Manual Review
        type: service
        service: case_management
        endpoint: enqueue_case
        params:
          queue: "standard_review"
          priority: "normal"
          context:
            risk_score: api.fraud_detector.analyze_transaction.risk_score
            is_high_amount: event.amount >= 3000
            amount: event.amount
        next: end

    # ========================================================================
    # Step 17: Update Risk Score (PUT API)
    # Demonstrates: PUT request for updates
    # ========================================================================
    - step:
        id: update_risk_score
        name: Update Transaction Risk Score
        type: api
        api: fraud_detector
        endpoint: update_risk
        # Parameters defined in API config
        # Request body: { "risk_score": computed_value, "reason": "..." }
        # Result stored in: api.fraud_detector.update_risk
        next: mark_as_processed

    # ========================================================================
    # Step 18: Mark as Processed (PATCH API)
    # Demonstrates: PATCH request for partial updates
    # ========================================================================
    - step:
        id: mark_as_processed
        name: Mark Transaction as Processed
        type: api
        api: fraud_detector
        endpoint: update_status
        # Parameters defined in API config
        # Request body: { "status": "processed" }
        # Result stored in: api.fraud_detector.update_status
        next: notify_user

    # ========================================================================
    # Step 19: Update Success Metrics (Service)
    # Demonstrates: Metrics update service
    # ========================================================================
    - step:
        id: update_success_metrics
        name: Update Success Metrics
        type: service
        service: metrics_service
        endpoint: increment_metric
        params:
          metric_name: "approved_transactions"
          increment: 1
          tags:
            is_high_amount: event.amount >= 1000
            channel: event.channel
        next: notify_user

    # ========================================================================
    # Step 20: Notify User (Service)
    # Demonstrates: Notification service
    # ========================================================================
    - step:
        id: notify_user
        name: Send User Notification
        type: service
        service: notification_service
        endpoint: send_notification
        params:
          channel: email
          template: "payment_status_update"
          user_id: event.user_id
          variables:
            amount: event.amount
            currency: event.currency
            transaction_id: event.transaction_id
        next: end

  # ==========================================================================
  # Final Decision Logic
  # ==========================================================================
  decision:
    # Rule 1: Critical risk - immediate decline
    - when:
        any:
          - results.vip_fast_rules.signal == "decline"
          - results.payment_high_value.signal == "decline"
          - results.payment_standard.signal == "decline"
          - results.cn_region_rules.signal == "decline"
          - api.fraud_detector.analyze_transaction.risk_score >= 90
      result: decline
      reason: "High risk detected"
      actions: ["BLOCK_USER", "NOTIFY_SECURITY_TEAM"]

    # Rule 2: Manual review required
    - when:
        any:
          - results.vip_fast_rules.signal == "review"
          - results.payment_high_value.signal == "review"
          - results.payment_standard.signal == "review"
          - results.cn_region_rules.signal == "review"
          - api.fraud_detector.analyze_transaction.risk_score >= 50
      result: review
      reason: "Manual review required"
      actions: ["QUEUE_MANUAL_REVIEW", "REQUEST_ADDITIONAL_VERIFICATION"]

    # Rule 3: VIP fast track approval
    - when:
        any:
          - results.vip_fast_rules.signal == "approve"
      result: approve
      reason: "VIP user approved"
      actions: ["FAST_TRACK_APPROVAL", "SEND_NOTIFICATION"]

    # Rule 4: Standard approval
    - when:
        all:
          - any:
              - results.payment_high_value.signal == "approve"
              - results.payment_standard.signal == "approve"
          - not:
              - any:
                  - api.fraud_detector.check_ip.is_vpn == true
                  - api.fraud_detector.check_ip.is_proxy == true
      result: approve
      reason: "Risk checks passed"
      actions: ["APPROVE_TRANSACTION", "UPDATE_METRICS"]

    # Default: Hold for further investigation
    - default: true
      result: hold
      reason: "Insufficient information for decision"
      actions: ["HOLD_TRANSACTION", "REQUEST_ADDITIONAL_DATA"]

  # ==========================================================================
  # Pipeline Metadata
  # ==========================================================================
  metadata:
    version: "2.0.0"
    author: "Risk Team"
    updated: "2026-01-09 10:00:00"
    category: fraud_detection
    tags:
      - comprehensive
      - api_integration
      - multi_step
      - production_ready
    description: |
      Comprehensive fraud detection pipeline demonstrating:
      - API methods (GET, POST, PUT, PATCH)
      - Complex conditional routing with nested all/any/not
      - All step types (router, api, service, ruleset, pipeline)
      - Sequential API fallback and multi-step enrichment
      - Complete decision flow from IP check to user notification
      - Final decision logic with multiple rules and actions

# =============================================================================
# PART 3: Condition Syntax Examples
# =============================================================================
#
# The `when` clause supports various condition patterns:
#
# 1. Simple Boolean Expression:
#    when: event.amount < 100
#
# 2. AND Logic (all conditions must be true):
#    when:
#      all:
#        - event.amount > 1000
#        - event.geo.country in ["US", "CA"]
#
# 3. OR Logic (any condition can be true):
#    when:
#      any:
#        - vars.total_score >= 80
#        - event.user.is_blacklisted == true
#
# 4. NOT Logic (negate condition):
#    when:
#      all:
#        - event.amount > 5000
#        - not:
#            - "proxy" in features.risk_tags
#
# 5. Complex Nested Conditions:
#    when:
#      any:
#        # Category A: High amount + High-risk country
#        - all:
#            - event.amount >= 3000
#            - event.geo.country in ["NG", "PK", "UA", "RU"]
#            - not:
#                - "vip" in event.user.tags
#        # Category B: Device/IP anomaly
#        - all:
#            - any:
#                - event.device.is_emulator == true
#                - api.network_check.is_proxy == true
#            - features.login_fail_count_1h >= 3
#
# =============================================================================

# =============================================================================
# PART 4: Compiler Validation Rules
# =============================================================================
#
# Errors:
# E001: entry must point to an existing step.id
# E002: all step.id must be unique
# E003: routes[].next and default/next must point to existing step.id or "end"
# E004: cannot have unreachable steps
# E005: cannot have circular references (unless marked as loop)
# E006: type-specific required field validation
# E007: terminal nodes must have next: end or no subsequent routes
#
# Warnings:
# W001: step not referenced by any other step (except entry)
# W002: routes[].when condition may never be satisfied
# W003: recommend adding default to handle unmatched cases
#
# =============================================================================

# =============================================================================
# PART 5: DAG Visualization Reference
# =============================================================================
#
#                    ┌────────────────────────┐
#                    │ check_ip_reputation    │ ← entry
#                    │      [api GET]         │
#                    └───────────┬────────────┘
#                                │
#            ┌───────────────────┼──────────────────┐
#            │ high_risk         │ clean            │ default
#            ▼                   ▼                  ▼
#      ┌──────────┐      ┌──────────────┐   ┌─────────────┐
#      │  manual  │      │ amount_router│   │ enhanced_ip │
#      │  review  │      │  [router]    │   │ check [api] │
#      └────┬─────┘      └──────┬───────┘   └──────┬──────┘
#           │                   │                   │
#           │          ┌────────┼────────┐          │
#           │          │        │        │          │
#           │     VIP  │  High  │  CN    │  Std     │
#           │          ▼        ▼        ▼          ▼
#           │     ┌─────┐  ┌──────┐ ┌──────┐  ┌──────────┐
#           │     │ vip │  │high_ │ │ cn_  │  │transact_ │◄─┘
#           │     │fast │  │value │ │region│  │analysis  │
#           │     │track│  │verif │ │flow  │  │[api POST]│
#           │     └──┬──┘  └──┬───┘ └──┬───┘  └────┬─────┘
#           │        │        │        │            │
#           │        │   ┌────┘        │       ┌────┴────┐
#           │        │   ▼             │       │         │
#           │        │ ┌────────┐      │  critical  high/low
#           │        │ │ final_ │      │       ▼         ▼
#           │        │ │scoring │      │   ┌──────┐  ┌────────┐
#           │        │ └───┬────┘      │   │auto_ │  │enhanced│
#           │        │     │           │   │reject│  │analysis│
#           │        │     │           │   └──┬───┘  └───┬────┘
#           │        └─────┼───────────┘      │          │
#           │              │                  │          ▼
#           │              │                  │    ┌──────────┐
#           │              │                  │    │aggregate │
#           │              │                  │    │ scores   │
#           │              │                  │    │[service] │
#           │              │                  │    └────┬─────┘
#           │              │                  │         │
#           │              ▼                  │         ▼
#           │         ┌─────────┐             │   ┌──────────┐
#           │         │standard │             │   │ standard │
#           │         │ scoring │             │   │ scoring  │
#           │         │[ruleset]│             │   │[ruleset] │
#           │         └────┬────┘             │   └────┬─────┘
#           │              │                  │        │
#           │              ▼                  │        │
#           │         ┌──────────┐            │        │
#           │         │  final   │◄───────────┴────────┘
#           │         │ decision │
#           │         │ [router] │
#           │         └────┬─────┘
#           │              │
#           │     ┌────────┼────────┐
#           │ >=80│   20-50│    <=20│
#           │     ▼        ▼        ▼
#           │  ┌──────┐ ┌──────┐ ┌──────┐
#           │  │auto_ │ │prior.│ │auto_ │
#           │  │apprv │ │review│ │reject│
#           │  └──┬───┘ └──┬───┘ └──┬───┘
#           │     │        │        │
#           │     ▼        │        ▼
#           │  ┌──────┐    │     ┌──────┐
#           │  │update│    │     │update│
#           │  │metric│    │     │risk_ │
#           │  └──┬───┘    │     │score │
#           │     │        │     └──┬───┘
#           │     │        │        │
#           │     │        │        ▼
#           │     │        │     ┌──────┐
#           │     │        │     │ mark │
#           │     │        │     │proc. │
#           │     │        │     └──┬───┘
#           │     │        │        │
#           │     └────────┼────────┘
#           │              │
#           │              ▼
#           │         ┌─────────┐
#           │         │ notify  │
#           │         │  user   │
#           │         │[service]│
#           │         └────┬────┘
#           │              │
#           └──────────────┴───────► END
#
# =============================================================================

# =============================================================================
# PART 6: LLM Generation Guidelines
# =============================================================================
#
# When generating Pipeline DSL, follow these constraints:
#
# 1. Structure:
#    - Must include: id, name, entry, steps
#    - entry must reference an existing step.id
#    - Each step must have unique id
#
# 2. Naming:
#    - id: snake_case (e.g., check_amount, get_ip_info)
#    - name: human-readable (e.g., "Check Transaction Amount")
#
# 3. Routing:
#    - Terminal nodes: next: end
#    - Conditional: routes + default
#    - Unconditional: next: <step_id>
#
# 4. Types:
#    - Pure routing → router
#    - Business rules → rule/ruleset
#    - Sub-pipeline → pipeline
#    - Internal data → service
#    - External API → api
#
# 5. Conditions:
#    - Use all/any/not for complex logic
#    - Nest arbitrarily deep
#    - Keep expressions readable
#
# 6. Best Practices:
#    - Top-to-bottom flow
#    - Group related steps
#    - Terminal steps at end
#    - Add descriptive comments
#
# =============================================================================

# END OF COMPREHENSIVE EXAMPLE
