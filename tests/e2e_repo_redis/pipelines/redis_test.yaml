# Redis E2E Test Pipeline
# Tests lookup features from Redis feature store

version: "0.2"

pipeline:
  id: redis_test_pipeline
  name: Redis Feature Store Test Pipeline
  description: Test pipeline using Redis lookup features

  # Match all event types for testing
  match:
    any:
      - event.type == "transaction"
      - event.type == "login"
      - event.type == "payment"

  # Pipeline entry point
  entry: extract_features

  # Steps
  steps:
    - id: extract_features
      type: feature_extraction
      features:
        - user_risk_score_90d
        - user_fraud_score
        - device_reputation_score
        - device_fraud_count_30d
        - ip_reputation_score
        - ip_fraud_rate_7d
        - user_avg_transaction_amount_30d
        - user_transaction_count_7d
        - user_unique_devices_30d
        - user_account_age_days
        - user_total_transactions
      next: evaluate_rules

    - id: evaluate_rules
      type: rule_evaluation
      rules:
        - high_risk_user
        - high_fraud_score
        - suspicious_device
        - risky_ip
        - new_account_high_value
        - high_velocity_user
        - multi_device_pattern
      next: make_decision

    - id: make_decision
      type: decision
      conclusion:
        - when: total_score >= 200
          signal: decline
          reason: "High risk score from feature store"

        - when: total_score >= 80
          signal: review
          reason: "Medium risk - manual review required"

        - when: total_score < 80
          signal: approve
          reason: "Low risk score"

---

# Rule: High Risk User
rule:
  id: high_risk_user
  name: High Risk User
  description: User has high risk score in feature store
  when:
    all:
      - features.user_risk_score_90d > 80
  score: 100

---

# Rule: High Fraud Score
rule:
  id: high_fraud_score
  name: High Fraud Score
  description: User has high fraud probability
  when:
    all:
      - features.user_fraud_score > 70
  score: 120

---

# Rule: Suspicious Device
rule:
  id: suspicious_device
  name: Suspicious Device
  description: Device has low reputation or fraud history
  when:
    any:
      - features.device_reputation_score < 30
      - features.device_fraud_count_30d > 5
  score: 80

---

# Rule: Risky IP
rule:
  id: risky_ip
  name: Risky IP Address
  description: IP has low reputation or high fraud rate
  when:
    any:
      - features.ip_reputation_score < 30
      - features.ip_fraud_rate_7d > 0.3
  score: 70

---

# Rule: New Account High Value
rule:
  id: new_account_high_value
  name: New Account High Value Transaction
  description: New account with high value transaction
  when:
    all:
      - event.type == "transaction"
      - event.amount > 1000
      - features.user_account_age_days < 7
      - features.user_total_transactions < 5
  score: 90

---

# Rule: High Velocity User
rule:
  id: high_velocity_user
  name: High Velocity User
  description: User has high transaction velocity
  when:
    all:
      - features.user_transaction_count_7d > 50
      - features.user_unique_devices_30d > 5
  score: 60

---

# Rule: Multi-Device Pattern
rule:
  id: multi_device_pattern
  name: Multi-Device Pattern
  description: User accessing from many devices
  when:
    all:
      - features.user_unique_devices_30d > 10
  score: 50
