version: "0.1"

# ========================================
# E2E Test Pipeline - Payment Flow
# ========================================

---

pipeline:
  id: payment_test_pipeline
  name: Payment E2E Test Pipeline
  description: Tests payment processing

  entry: payment_risk_assessment

  when:
    all:
      - event.type == "payment"

  steps:
    - step:
        id: payment_risk_assessment
        name: Payment Risk Assessment
        type: ruleset
        ruleset: payment_risk_ruleset

  # Final decision based on ruleset signals
  decision:
    - when: results.payment_risk_ruleset.signal == "decline"
      result: decline
      reason: "{results.payment_risk_ruleset.reason}"
      terminate: true

    - when: results.payment_risk_ruleset.signal == "review"
      result: review
      reason: "{results.payment_risk_ruleset.reason}"
      terminate: true

    - default: true
      result: approve
      reason: "Payment approved"

---

# ========================================
# Rules
# ========================================

# Rule: User in Blocklist
rule:
  id: user_in_blocklist
  name: User in Blocklist
  description: User is blocked
  when:
    all:
      - event.user_id in list.blocked_users
  score: 1000

---

# Rule: High Risk Location
rule:
  id: high_risk_location
  name: High Risk Location
  description: Payment from high-risk country
  when:
    all:
      - event.country in list.high_risk_countries
  score: 60

---

# Rule: Very High Amount
rule:
  id: very_high_amount
  name: Very High Amount
  description: Extremely high payment amount
  when:
    all:
      - event.amount > 5000
  score: 100

---

# Rule: Daily Limit Exceeded
rule:
  id: daily_limit_exceeded
  name: Daily Limit Exceeded
  description: Daily payment limit exceeded
  when:
    all:
      - features.txn_amount_24h > 10000
  score: 200

---

# Rule: Crypto Payment Risk
rule:
  id: crypto_payment_risk
  name: Crypto Payment Risk
  description: High-value crypto payment detection
  when:
    all:
      - event.payment_method == "crypto"
      - event.amount > 1000
  score: 100

---

# Rule: High Payment Frequency
rule:
  id: high_payment_frequency
  name: High Payment Frequency
  description: Too many payments in 24 hours (tests payment_count_24h)
  when:
    all:
      - features.payment_count_24h >= 5
  score: 110

---

# Rule: Weekly Payment Limit
rule:
  id: weekly_payment_limit
  name: Weekly Payment Limit
  description: Weekly payment limit exceeded (tests payment_sum_7d)
  when:
    all:
      - features.payment_sum_7d > 20000
  score: 160

---

# Rule: Max Payment Exceeded
rule:
  id: max_payment_exceeded
  name: Max Payment Exceeded
  description: Payment exceeds historical maximum (tests max_payment_amount_30d)
  when:
    all:
      - features.max_payment_amount_30d > 0
      - event.amount > features.max_payment_amount_30d * 2
  score: 170

---

# Rule: Payment Dominance
rule:
  id: payment_dominance
  name: Payment Dominance
  description: Payments dominate transactions (tests payment_to_txn_ratio expression)
  when:
    all:
      - features.payment_to_txn_ratio > 0.8
  score: 50

---

# ========================================
# Ruleset
# ========================================

ruleset:
  id: payment_risk_ruleset
  name: Payment Risk Ruleset
  description: E2E test ruleset for payment risk assessment

  rules:
    - user_in_blocklist
    - high_risk_location
    - very_high_amount
    - daily_limit_exceeded
    - crypto_payment_risk
    - high_payment_frequency
    - weekly_payment_limit
    - max_payment_exceeded
    - payment_dominance

  # Conclusion produces signals
  conclusion:
    # Critical risk - blocked user or limit exceeded
    - when: triggered_rules contains "user_in_blocklist"
      signal: decline
      reason: "User is in blocklist"
      terminate: true

    - when: triggered_rules contains "daily_limit_exceeded"
      signal: decline
      reason: "Daily payment limit exceeded"
      terminate: true

    # High risk
    - when: total_score >= 150
      signal: decline
      reason: "High risk score threshold exceeded"
      terminate: true

    # Medium risk - review
    - when: total_score >= 100
      signal: review
      reason: "Medium risk - manual review required"
      terminate: true

    # Low risk - approve (default)
    - default: true
      signal: approve
      reason: "No significant risk indicators"
