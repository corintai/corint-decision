version: "0.1"

# ========================================
# E2E Test Pipeline - Database List Test
# ========================================

---

pipeline:
  id: db_list_test_pipeline
  name: Database List E2E Test Pipeline
  description: Tests database-backed list lookups

  entry: db_list_check

  when:
    all:
      - event.type == "db_list_test"

  steps:
    - step:
        id: db_list_check
        name: Database List Check
        type: ruleset
        ruleset: db_list_test_ruleset

  # Final decision based on ruleset signals
  decision:
    - when: results.db_list_test_ruleset.signal == "decline"
      result: decline
      reason: "{results.db_list_test_ruleset.reason}"

    - when: results.db_list_test_ruleset.signal == "review"
      result: review
      reason: "{results.db_list_test_ruleset.reason}"

    - default: true
      result: approve
      reason: "No lists matched"

---

# ========================================
# Rules for Database List Testing
# ========================================

# Rule: User in Database Blocklist (checks both memory and db-backed lists)
rule:
  id: user_in_db_blocklist
  name: User in DB Blocklist
  description: User is in blocked list (memory-backed for basic tests)
  when:
    all:
      - event.user_id in list.blocked_users
  score: 1000

---

# Rule: User in DB Blocklist with Expiration
rule:
  id: user_in_db_blocklist_expiration
  name: User in DB Blocklist (Expiration)
  description: User is in database-backed blocked list with expiration support
  when:
    all:
      - event.user_id in list.blocked_users_db
  score: 1000

---

# Rule: IP in Database Blocklist
rule:
  id: ip_in_db_blocklist
  name: IP in DB Blocklist
  description: IP address is in blocked list
  when:
    all:
      - event.ip_address in list.blocked_ips
  score: 1000

---

# Rule: Country in High Risk List
rule:
  id: country_in_db_high_risk
  name: Country in DB High Risk List
  description: Country is in high risk list
  when:
    all:
      - event.country in list.high_risk_countries
  score: 500

---

# ========================================
# Ruleset
# ========================================

ruleset:
  id: db_list_test_ruleset
  name: Database List Test Ruleset
  description: E2E test ruleset for database list lookups

  rules:
    - user_in_db_blocklist
    - user_in_db_blocklist_expiration
    - ip_in_db_blocklist
    - country_in_db_high_risk

  # Conclusion produces signals
  conclusion:
    # Critical risk - blocked user (memory list)
    - when: triggered_rules contains "user_in_db_blocklist"
      signal: decline
      reason: "User is in blocklist"

    # Critical risk - blocked user (db list with expiration)
    - when: triggered_rules contains "user_in_db_blocklist_expiration"
      signal: decline
      reason: "User is in database blocklist (with expiration check)"

    - when: triggered_rules contains "ip_in_db_blocklist"
      signal: decline
      reason: "IP is in blocklist"

    # High risk country
    - when: triggered_rules contains "country_in_db_high_risk"
      signal: review
      reason: "Country is in high risk list"

    # No match - approve
    - default: true
      signal: approve
      reason: "No lists matched"
