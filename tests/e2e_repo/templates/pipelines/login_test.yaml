version: "0.1"

# ========================================
# E2E Test Pipeline - Login Flow
# ========================================

---

pipeline:
  id: login_test_pipeline
  name: Login E2E Test Pipeline
  description: Tests login risk assessment

  entry: login_risk_assessment

  when:
    all:
      - event.type == "login"

  steps:
    - step:
        id: login_risk_assessment
        name: Login Risk Assessment
        type: ruleset
        ruleset: login_risk_ruleset

  # Final decision based on ruleset signals
  decision:
    - when: results.login_risk_ruleset.signal == "decline"
      result: decline
      reason: "{results.login_risk_ruleset.reason}"

    - when: results.login_risk_ruleset.signal == "review"
      result: review
      reason: "{results.login_risk_ruleset.reason}"

    - default: true
      result: approve
      reason: "Login approved"

---

# ========================================
# Rules
# ========================================

# Rule: Blocked IP
rule:
  id: blocked_ip
  name: Blocked IP
  description: IP address is in blocklist
  when:
    all:
      - event.ip_address in list.blocked_ips
  score: 1000

---

# Rule: Excessive Failed Logins
rule:
  id: excessive_failures
  name: Excessive Failed Logins
  description: Too many failed login attempts
  when:
    all:
      - features.failed_login_count_24h >= 5
  score: 200

---

# Rule: Multiple Failed Logins
rule:
  id: multiple_failures
  name: Multiple Failed Logins
  description: Multiple failed attempts
  when:
    all:
      - features.failed_login_count_24h >= 3
  score: 100

---

# Rule: New Device High Risk Country
rule:
  id: new_device_high_risk_country
  name: New Device High Risk Country
  description: Login from new device in high-risk country
  when:
    all:
      - features.unique_devices_7d > 1
      - event.country in list.high_risk_countries
  score: 90

---

# Rule: Unusual Device Count
rule:
  id: unusual_device_count
  name: Unusual Device Count
  description: Too many different devices
  when:
    all:
      - features.unique_devices_7d >= 5
  score: 60

---

# Rule: Location Hopping
rule:
  id: location_hopping
  name: Location Hopping
  description: Activity across many locations
  when:
    all:
      - features.unique_countries_30d >= 4
  score: 50

---

# Rule: Low Login History
rule:
  id: low_login_history
  name: Low Login History
  description: Low activity user from high-risk country (tests successful_login_count_7d)
  when:
    all:
      - features.successful_login_count_7d < 2
      - event.country in list.high_risk_countries
  score: 80

---

# Rule: Multiple IPs 24h
rule:
  id: multiple_ips_24h
  name: Multiple IPs 24h
  description: Multiple IP addresses in 24 hours (tests unique_ips_24h)
  when:
    all:
      - features.unique_ips_24h >= 5
  score: 50

---

# Rule: High Failure Rate
rule:
  id: high_failure_rate
  name: High Failure Rate
  description: High failed login rate (tests rate_failed_login expression)
  when:
    all:
      - features.rate_failed_login > 0.5
  score: 65

---

# Rule: Device Velocity Anomaly
rule:
  id: device_velocity_anomaly
  name: Device Velocity Anomaly
  description: Abnormal device switching pattern (tests device_velocity_ratio expression)
  when:
    all:
      - features.unique_devices_24h >= 2
      - features.device_velocity_ratio > 0.7
  score: 80

---

# Rule: Shared Device
rule:
  id: shared_device
  name: Shared Device
  description: Device used by multiple users (tests unique_users_by_device_7d)
  when:
    all:
      - features.unique_users_by_device_7d >= 5
  score: 90

---

# ========================================
# Ruleset
# ========================================

ruleset:
  id: login_risk_ruleset
  name: Login Risk Ruleset
  description: E2E test ruleset for login risk assessment

  rules:
    - blocked_ip
    - excessive_failures
    - multiple_failures
    - new_device_high_risk_country
    - unusual_device_count
    - location_hopping
    - low_login_history
    - multiple_ips_24h
    - high_failure_rate
    - device_velocity_anomaly
    - shared_device

  # Conclusion produces signals
  conclusion:
    # Critical risk - blocked IP or too many failures
    - when: triggered_rules contains "blocked_ip"
      signal: decline
      reason: "Blocked IP address"

    - when: triggered_rules contains "excessive_failures"
      signal: decline
      reason: "Excessive failed login attempts"

    # High risk
    - when: total_score >= 250
      signal: decline
      reason: "High risk score threshold exceeded"

    - when: triggered_count >= 6
      signal: decline
      reason: "Multiple risk indicators detected"

    # Medium risk - review
    - when: total_score >= 50
      signal: review
      reason: "Medium risk score - manual review required"

    - when: triggered_count >= 2
      signal: review
      reason: "Multiple risk factors require review"

    # Low risk - approve (default)
    - default: true
      signal: approve
      reason: "No significant risk indicators"
