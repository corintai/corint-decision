version: "0.1"

# Login Risk Assessment Ruleset
# Comprehensive login security rules with device, location, and behavior analysis

import:
  rules:
    # Disabled: requires unimplemented features (geo_distance_from_last_login, hours_since_last_login)
    # - library/rules/account/impossible_travel.yaml
    - library/rules/account/off_hours_activity.yaml
    - library/rules/account/password_change_risk.yaml
    - library/rules/device/device_emulator.yaml
    # Disabled: requires unimplemented features (device_fingerprint_changed_24h)
    # - library/rules/device/device_spoofing.yaml
    - library/rules/fraud/account_takeover.yaml
    - library/rules/fraud/login_velocity.yaml 

---

ruleset:
  id: login_risk
  name: Login Risk Assessment Ruleset
  description: |
    Specialized ruleset for login scenario risk assessment.

    Covers multiple risk dimensions:
    1. Device Trust (80-85pts) - Emulators, spoofing, rooted devices
    2. Account Takeover (85pts) - Combined takeover indicators
    3. Password Security (70pts) - High-risk password changes
    4. Login Velocity (40pts) - High login frequency

    Total risk scoring with multi-layer decision logic.

  # Reference imported rules by their IDs
  rules:
    - device_emulator_detection
    - account_takeover_pattern
    - password_change_risk
    - login_velocity_pattern

  # Multi-layer decision logic
  conclusion:
    # ==========================================
    # Priority 1: Critical Device Threats
    # ==========================================

    # Emulator/Virtual device - immediate deny
    - when: triggered_rules contains "device_emulator_detection"
      signal: decline
      reason: "Critical: Emulator or virtual device detected"

    # Device spoofing - immediate deny (DISABLED - requires unimplemented features)
    # - when: triggered_rules contains "device_spoofing_detection"
    #   signal: decline
    #   reason: "Critical: Device fingerprint spoofing detected"

    # ==========================================
    # Priority 2: Account Takeover Patterns
    # ==========================================

    # Impossible travel + account takeover indicators (DISABLED - requires unimplemented features)
    # - when: |
    #     triggered_rules contains "impossible_travel_detection" &&
    #     (triggered_rules contains "account_takeover_new_device" ||
    #      triggered_rules contains "account_takeover_failed_logins" ||
    #      triggered_rules contains "account_takeover_geo_change")
    #   signal: decline
    #   reason: "Critical: Impossible travel with account takeover pattern"

    # Account takeover with password change
    - when: |
        triggered_rules contains "account_takeover_pattern" &&
        triggered_rules contains "password_change_risk"
      signal: decline
      reason: "Critical: Account takeover with password change attempt"

    # ==========================================
    # Priority 3: Score-Based Thresholds
    # ==========================================

    # Critical Risk >= 150 (multiple high-severity patterns)
    - when: total_score >= 150
      signal: decline
      reason: "Critical risk - multiple security threats (score: {total_score})"

    # Very High Risk >= 100
    - when: total_score >= 100
      signal: decline
      reason: "Very high risk - clear security threat (score: {total_score})"

    # High Risk >= 70 - Requires additional verification
    - when: total_score >= 70
      signal: review
      reason: "High risk login - requires MFA or manual review (score: {total_score})"

    # Medium Risk >= 40 - Enhanced monitoring (aligned with login_velocity score)
    - when: total_score >= 40
      signal: review
      reason: "Medium risk - enhanced monitoring required (score: {total_score})"

    # Low-Medium Risk >= 30 - Basic monitoring
    - when: total_score >= 30
      signal: review
      reason: "Low-medium risk - basic monitoring required (score: {total_score})"

    # ==========================================
    # Priority 4: Multiple Indicators
    # ==========================================

    # Multiple risk indicators present (2 or more)
    - when: triggered_count >= 2
      signal: review
      reason: "Multiple risk indicators detected ({triggered_count} patterns)"

    # ==========================================
    # Priority 5: Default Action
    # ==========================================

    # Low Risk (default) - approve with logging
    - default: true
      signal: approve
      reason: "Low risk - normal login pattern"

  metadata:
    # Required fields
    version: "1.0.0"
    author: "Risk Engineering Team"
    updated: "2025-12-20 10:00:00"

    # Custom fields
    owner: "security_team"
    tags: [login, authentication, account_security, device_trust]
    change_log:
      - version: "1.0.0"
        date: "2025-12-14"
        changes: "Initial release with 7 login security rules (account_takeover split into 3 rules to work around 'any:' compiler bug)"
