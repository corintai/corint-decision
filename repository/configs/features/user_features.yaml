# User Feature Definitions
#
# This file defines features computed for user risk assessment.
# Features are computed using operators with parameterized dimensions and windows.

features:
  # ============================================================================
  # Basic Count Features
  # ============================================================================

  - name: login_count_24h
    description: "Number of login events in last 24 hours"
    type: aggregation
    method: count
    datasource: supabase_events  # Explicitly specify data source
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    window: 24h
    timestamp_field: timestamp
    when: event_type == "login"

  - name: login_count_1h
    description: "Number of login events in last 1 hour"
    type: aggregation
    method: count
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    window: 1h
    timestamp_field: timestamp
    when: event_type == "login"

  - name: failed_login_count_1h
    description: "Number of failed login attempts in last 1 hour"
    type: aggregation
    method: count
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    window: 1h
    timestamp_field: timestamp
    when:
      all:
        - event_type == "login"
        - status == "failed"

  - name: transaction_count_24h
    description: "Number of transactions in last 24 hours"
    type: aggregation
    method: count
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    window: 24h
    timestamp_field: timestamp
    when: event_type == "transaction"

  # ============================================================================
  # Aggregation Features (Sum, Avg, Max, Min)
  # ============================================================================

  - name: transaction_sum_24h
    description: "Total transaction amount in last 24 hours"
    type: aggregation
    method: sum
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    field: amount
    window: 24h
    timestamp_field: timestamp
    when: event_type == "transaction"

  - name: transaction_sum_7d
    description: "Total transaction amount in last 7 days"
    type: aggregation
    method: sum
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    field: amount
    window: 7d
    timestamp_field: timestamp
    when: event_type == "transaction"

  - name: avg_transaction_30d
    description: "Average transaction amount in last 30 days"
    type: aggregation
    method: avg
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    field: amount
    window: 30d
    timestamp_field: timestamp
    when: event_type == "transaction"

  - name: max_transaction_14d
    description: "Maximum transaction amount in last 7 days"
    type: aggregation
    method: max
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    field: amount
    window: 14d
    timestamp_field: timestamp
    when: event_type == "transaction"

  # ============================================================================
  # Count Distinct Features
  # ============================================================================

  - name: unique_devices_7d
    description: "Number of distinct devices used in last 7 days"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    field: device_id
    window: 7d
    timestamp_field: timestamp

  - name: unique_devices_30d
    description: "Number of distinct devices used in last 30 days"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    field: device_id
    window: 30d
    timestamp_field: timestamp

  - name: unique_ips_24h
    description: "Number of distinct IP addresses in last 24 hours"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    field: ip_address
    window: 24h
    timestamp_field: timestamp

  - name: unique_cities_30d
    description: "Number of distinct cities accessed from in last 30 days"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    field: city
    window: 30d
    timestamp_field: timestamp

  # ============================================================================
  # Temporal Features
  # ============================================================================

  - name: account_first_seen
    description: "Timestamp of first user event"
    type: state
    method: first_seen
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id

  - name: last_login_at
    description: "Timestamp of last login"
    type: state
    method: last_seen
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    when: event_type == "login"

  - name: account_age_days
    description: "Days since account creation"
    type: state
    method: time_since
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: event.user_id
    when: event_type == "register"
    unit: days

  # ============================================================================
  # Velocity Features
  # NOTE: These features use operators not yet implemented in the DSL
  # They are commented out until the feature DSL supports them
  # ============================================================================

  # - name: exceeds_login_velocity
  #   description: "Does user exceed maximum login velocity (> 10 per hour)?"
  #   type: Expression  # Not yet implemented
  #   method: velocity
  #   datasource: supabase_events
  #   entity: events
  #   dimension: user_id
  #   dimension_value: event.user_id
  #   window:
  #     value: 1
  #     unit: hours
  #   threshold: 10
  #   when:
  #     - field: event_type
  #       operator: eq
  #       value: "login"
  #   cache:
  #     enabled: true
  #     ttl: 60

  # - name: exceeds_transaction_velocity
  #   description: "Does user exceed transaction velocity (> 5 per hour)?"
  #   type: Expression  # Not yet implemented
  #   method: velocity
  #   datasource: supabase_events
  #   entity: events
  #   dimension: user_id
  #   dimension_value: event.user_id
  #   window:
  #     value: 1
  #     unit: hours
  #   threshold: 5
  #   when:
  #     - field: event_type
  #       operator: eq
  #       value: "transaction"
  #   cache:
  #     enabled: true
  #     ttl: 60

  # ============================================================================
  # Lookup Features (from Feature Store / Database)
  # ============================================================================

  - name: user_risk_score
    description: "Pre-computed user risk score from feature store"
    type: lookup
    datasource: redis_features
    key: "user_features:${event.user_id}:risk_score"
    fallback: 0.0

  - name: user_kyc_status
    description: "User KYC status from profile database"
    type: lookup
    datasource: redis_features
    key: "user_profiles:${event.user_id}:kyc_status"
    fallback: "unknown"

  - name: user_is_verified
    description: "Is user identity verified?"
    type: lookup
    datasource: redis_features
    key: "user_profiles:${event.user_id}:is_verified"
    fallback: false

