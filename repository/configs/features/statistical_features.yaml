# Statistical Features Configuration
#
# Advanced statistical analysis features for anomaly detection

features:
  # ============================================================================
  # Z-Score and Outlier Detection
  # ============================================================================

  - name: transaction_amount_zscore
    description: "Transaction amount Z-Score (standard deviation from mean)"
    operator: zscore
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    field: amount
    window:
      value: 30
      unit: days
    filters:
      - field: event_type
        operator: eq
        value: "transaction"
    cache:
      enabled: true
      ttl: 300

  - name: is_amount_outlier_p95
    description: "Is transaction amount above 95th percentile?"
    operator: percentile_check
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    field: amount
    percentile: 95
    window:
      value: 90
      unit: days
    filters:
      - field: event_type
        operator: eq
        value: "transaction"
    cache:
      enabled: true
      ttl: 600

  - name: is_amount_outlier_p99
    description: "Is transaction amount above 99th percentile? (Very rare)"
    operator: percentile_check
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    field: amount
    percentile: 99
    window:
      value: 90
      unit: days
    filters:
      - field: event_type
        operator: eq
        value: "transaction"

  # ============================================================================
  # Velocity Features
  # ============================================================================

  - name: spending_velocity_ratio
    description: "Spending velocity change ratio (24h vs 7d baseline)"
    operator: velocity_ratio
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    numerator_window:
      value: 24
      unit: hours
    denominator_window:
      value: 7
      unit: days
    field: amount
    filters:
      - field: event_type
        operator: eq
        value: "transaction"
    cache:
      enabled: true
      ttl: 300

  - name: login_velocity_ratio
    description: "Login frequency change ratio (24h vs 7d baseline)"
    operator: velocity_ratio
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    numerator_window:
      value: 24
      unit: hours
    denominator_window:
      value: 7
      unit: days
    operation: count
    filters:
      - field: event_type
        operator: eq
        value: "login"

  # ============================================================================
  # Time-Based Features
  # ============================================================================

  - name: is_off_hours
    description: "Is event during off-hours (22:00-06:00)?"
    operator: time_check
    datasource: computed
    time_ranges:
      - start: "22:00"
        end: "06:00"

  - name: is_weekend
    description: "Is event on weekend?"
    operator: day_check
    datasource: computed
    days: ["saturday", "sunday"]

  # ============================================================================
  # Geographic Features (for login events)
  # ============================================================================

  - name: hours_since_last_login
    description: "Hours since user's last login"
    operator: time_since
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    timestamp_field: event_timestamp
    filters:
      - field: event_type
        operator: eq
        value: "login"
    cache:
      enabled: true
      ttl: 60

  - name: geo_distance_from_last_login
    description: "Distance (km) from last login location"
    operator: geo_distance
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    location_field: location
    filters:
      - field: event_type
        operator: eq
        value: "login"
    cache:
      enabled: true
      ttl: 300

  - name: country_changed
    description: "Has user's country changed since last login?"
    operator: value_changed
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    field: country
    filters:
      - field: event_type
        operator: eq
        value: "login"

  # ============================================================================
  # Device Features
  # ============================================================================

  - name: is_new_device
    description: "Is this device new for the user?"
    operator: is_new_value
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    field: device_id
    window:
      value: 30
      unit: days

  - name: device_fingerprint_changed_24h
    description: "Has device fingerprint changed in last 24h?"
    operator: value_changed
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: "{event.device_id}"
    field: device_fingerprint
    window:
      value: 24
      unit: hours

  - name: failed_login_count_1h
    description: "Failed login attempts in last 1 hour"
    operator: count
    datasource: supabase_events
    entity: events
    dimension: user_id
    dimension_value: "{event.user_id}"
    window:
      value: 1
      unit: hours
    filters:
      - field: event_type
        operator: eq
        value: "login_failed"

  # ============================================================================
  # Association Analysis Features
  # ============================================================================

  - name: devices_per_ip_5h
    description: "Number of distinct devices from same IP (5h window)"
    operator: cross_dimension_count
    datasource: supabase_events
    entity: events
    primary_dimension: ip_address
    primary_value: "{event.ip_address}"
    secondary_dimension: device_id
    window:
      value: 5
      unit: hours
    cache:
      enabled: true
      ttl: 300

  - name: users_per_ip_5h
    description: "Number of distinct users from same IP (5h window)"
    operator: cross_dimension_count
    datasource: supabase_events
    entity: events
    primary_dimension: ip_address
    primary_value: "{event.ip_address}"
    secondary_dimension: user_id
    window:
      value: 5
      unit: hours
    cache:
      enabled: true
      ttl: 300

  - name: users_per_device_24h
    description: "Number of distinct users on same device (24h window)"
    operator: cross_dimension_count
    datasource: supabase_events
    entity: events
    primary_dimension: device_id
    primary_value: "{event.device_id}"
    secondary_dimension: user_id
    window:
      value: 24
      unit: hours
    cache:
      enabled: true
      ttl: 600

  # ============================================================================
  # Fraud Pattern Features
  # ============================================================================

  - name: ip_device_count
    description: "Devices associated with IP (fraud farm detection)"
    operator: cross_dimension_count
    datasource: supabase_events
    entity: events
    primary_dimension: ip_address
    primary_value: "{event.ip_address}"
    secondary_dimension: device_id
    window:
      value: 5
      unit: hours

  - name: ip_user_count
    description: "Users associated with IP (fraud farm detection)"
    operator: cross_dimension_count
    datasource: supabase_events
    entity: events
    primary_dimension: ip_address
    primary_value: "{event.ip_address}"
    secondary_dimension: user_id
    window:
      value: 5
      unit: hours
