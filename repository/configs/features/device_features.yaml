# Device Feature Definitions
#
# Features computed based on device_id dimension.

features:
  # ============================================================================
  # Device Activity Features
  # ============================================================================

  - name: device_event_count_3mo
    description: "Total events from this device in last 24 hours"
    type: aggregation
    method: count
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: event.device_id
    window: 3mo
    timestamp_field: timestamp

  - name: device_transaction_count_6mo
    description: "Transactions from this device in last 3 months"
    type: aggregation
    method: count
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: event.device_id
    window: 6mo
    timestamp_field: timestamp
    when: event_type == "transaction"

  # ============================================================================
  # Cross-Dimensional Features
  # ============================================================================

  - name: users_per_device_30d
    description: "Number of distinct users on this device in last 30 days"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: event.device_id
    field: user_id
    window: 30d
    timestamp_field: timestamp

  - name: ips_per_device_7d
    description: "Number of distinct IPs for this device in last 7 days"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: device_id
    dimension_value: event.device_id
    field: ip_address
    window: 7d
    timestamp_field: timestamp

  # ============================================================================
  # Device Profile Lookups
  # ============================================================================

  - name: device_risk_score
    description: "Pre-computed device risk score from feature store"
    type: lookup
    datasource: redis_features
    key: "device_features:${event.device_id}:risk_score"
    fallback: 0.0

  - name: devices_per_user_30d
    description: "Number of distinct devices per user in last 30 days"
    type: lookup
    datasource: redis_features
    key: "devices_per_user_30d:${event.user_id}"
    fallback: 0

