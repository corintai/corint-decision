# IP Address Feature Definitions
#
# Features computed based on ip_address dimension.

features:
  # ============================================================================
  # IP Activity Features
  # ============================================================================

  - name: ip_event_count_1h
    description: "Total events from this IP in last 1 hour"
    type: aggregation
    method: count
    datasource: supabase_events
    entity: events
    dimension: ip_address
    dimension_value: event.ip_address
    window: 1h
    timestamp_field: timestamp

  - name: ip_login_count_24h
    description: "Login attempts from this IP in last 24 hours"
    type: aggregation
    method: count
    datasource: supabase_events
    entity: events
    dimension: ip_address
    dimension_value: event.ip_address
    window: 24h
    timestamp_field: timestamp
    when: event_type == "login"

  # ============================================================================
  # Cross-Dimensional Features (Association Analysis)
  # NOTE: cross_dimension_count is not yet implemented in the DSL
  # For now, using count_distinct as workaround
  # ============================================================================

  - name: devices_per_ip_5h
    description: "Number of distinct devices from this IP in last 5 hours"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: ip_address
    dimension_value: event.ip_address
    field: device_id
    window: 5h
    timestamp_field: timestamp

  - name: devices_per_ip_24h
    description: "Number of distinct devices from this IP in last 24 hours"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: ip_address
    dimension_value: event.ip_address
    field: device_id
    window: 24h
    timestamp_field: timestamp

  - name: users_per_ip_24h
    description: "Number of distinct users from this IP in last 24 hours"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: ip_address
    dimension_value: event.ip_address
    field: user_id
    window: 24h
    timestamp_field: timestamp

  - name: cities_per_ip_30d
    description: "Number of distinct cities for this IP in last 30 days"
    type: aggregation
    method: distinct
    datasource: supabase_events
    entity: events
    dimension: ip_address
    dimension_value: event.ip_address
    field: city
    window: 30d
    timestamp_field: timestamp

  # ============================================================================
  # Velocity Features
  # NOTE: velocity operator is not yet implemented in the DSL
  # Commented out until supported
  # ============================================================================

  # - name: exceeds_ip_velocity
  #   description: "Does IP exceed event velocity (> 100 per hour)?"
  #   type: Expression  # Not yet implemented
  #   method: velocity
  #   datasource: supabase_events
  #   entity: events
  #   dimension: ip_address
  #   dimension_value: event.ip_address
  #   window:
  #     value: 1
  #     unit: hours
  #   threshold: 100
  #   cache:
  #     enabled: true
  #     ttl: 60

  # ============================================================================
  # Temporal Features
  # ============================================================================

  - name: ip_first_seen
    description: "First time this IP was seen"
    type: state
    method: first_seen
    datasource: supabase_events
    entity: events
    dimension: ip_address
    dimension_value: event.ip_address

  # ============================================================================
  # IP Lookup Features
  # ============================================================================

  - name: ip_risk_score
    description: "Pre-computed IP risk score from feature store"
    type: lookup
    datasource: redis_features
    key: "ip_features:${event.ip_address}:risk_score"
    fallback: 0.0

  - name: ip_country
    description: "Country associated with this IP"
    type: lookup
    datasource: redis_features
    key: "ip_features:${event.ip_address}:country"
    fallback: "unknown"

