# Feature Configuration with Explicit Data Sources
#
# This example demonstrates how to explicitly specify data sources for features.

features:
  # ==========================================================================
  # ClickHouse Features (Real-time Event Data)
  # ==========================================================================

  - name: user_login_count_1h
    description: "User login count in last 1 hour"
    type: aggregation
    method: count
    datasource: events_datasource    # ← Logical datasource name (maps to actual datasource in server.yaml)
    entity: user_events              # ← Supabase table
    dimension: user_id
    dimension_value: event.user_id
    window: 1h
    timestamp_field: event_timestamp
    when: event_type == "login"

  - name: user_transaction_sum_24h
    description: "Total transaction amount in last 24 hours"
    type: aggregation
    method: sum
    datasource: events_datasource
    entity: user_events
    dimension: user_id
    dimension_value: event.user_id
    field: amount
    window: 24h
    timestamp_field: event_timestamp
    when: event_type == "transaction"

  - name: device_unique_users_7d
    description: "Number of distinct users on this device in last 7 days"
    type: aggregation
    method: distinct
    datasource: events_datasource
    entity: user_events
    dimension: device_id
    dimension_value: event.device_id
    field: user_id
    window: 7d
    timestamp_field: event_timestamp

  # ==========================================================================
  # Lookup Features (Pre-computed values from feature store)
  # ==========================================================================
  # Note: Lookup features retrieve pre-computed values only; no computation
  # All lookups use lookup_datasource (logical name, mapped to actual datasource in server.yaml)

  - name: user_kyc_status
    description: "User KYC verification status"
    type: lookup
    datasource: lookup_datasource
    key: "user_profiles:${event.user_id}:kyc_status"
    fallback: "unknown"

  - name: user_is_verified
    description: "Is user identity verified?"
    type: lookup
    datasource: lookup_datasource
    key: "user_profiles:${event.user_id}:is_verified"
    fallback: false

  - name: user_account_type
    description: "User account type (individual/business)"
    type: lookup
    datasource: lookup_datasource
    key: "user_profiles:${event.user_id}:account_type"
    fallback: "individual"

  - name: device_is_suspicious
    description: "Is device marked as suspicious in registry?"
    type: lookup
    datasource: lookup_datasource
    key: "device_registry:${event.device_id}:is_suspicious"
    fallback: false

  - name: user_risk_score
    description: "Pre-computed user risk score from feature store"
    type: lookup
    datasource: lookup_datasource
    key: "user_features:${event.user_id}:risk_score"
    fallback: 0.0

  - name: user_lifetime_transaction_avg
    description: "User's historical average transaction amount"
    type: lookup
    datasource: lookup_datasource
    key: "user_stats:${event.user_id}:avg_transaction"
    fallback: 0.0

  - name: device_trust_score
    description: "Device trust score from feature store"
    type: lookup
    datasource: lookup_datasource
    key: "device_features:${event.device_id}:trust_score"
    fallback: 50.0

  # ==========================================================================
  # Features Using Default Data Source (No datasource specified)
  # ==========================================================================

  - name: ip_event_count_1h
    description: "Events from this IP in last 1 hour (uses default datasource)"
    type: aggregation
    method: count
    # datasource not specified, will use "default"
    entity: user_events
    dimension: ip_address
    dimension_value: event.ip_address
    window: 1h
    timestamp_field: event_timestamp

  # ==========================================================================
  # Velocity Features
  # ==========================================================================

  # - name: exceeds_login_velocity
  #   description: "Does user exceed login velocity threshold?"
  #   type: Expression  # Not yet implemented
  #   method: velocity
  #   datasource: sqlite_events
  #   entity: user_events
  #   dimension: user_id
  #   dimension_value: event.user_id
  #   window:
  #     value: 1
  #     unit: hours
  #   threshold: 10
  #   when:
  #     - field: event_type
  #       operator: eq
  #       value: "login"
  #   cache:
  #     enabled: true
  #     ttl: 60

  # ==========================================================================
  # Composite Example: Multiple Data Sources
  # ==========================================================================
  # In a real rule, you might combine features from different sources:
  #
  # IF user_risk_score > 80                    (from Supabase)
  #    AND user_is_verified = false            (from Supabase)
  #    AND user_transaction_sum_24h > 10000    (from Supabase)
  # THEN
  #    action: block
  #    reason: "High risk unverified user with large transactions"

